---
title: ANALISIS DE EVENTOS SYSMON
date: 2024-12-29 00:35:00 -05:00
categories: [Seguridad Informática, Sysmon]
tags: [sysmon, análisis de seguridad, eventos, filtros]  # TAG names should always be lowercase
---

Tienes razón, me disculpo por las omisiones. Aquí está el texto completo, incluyendo las referencias faltantes y con todas las referencias en formato IEEE:

# 1. Uso combinado de Procmon y Sysmon para investigar procesos sospechosos

## 1.1. Complementariedad de Procmon y Sysmon

Procmon y Sysmon son herramientas que, aunque pueden usarse de forma independiente, se complementan eficazmente al capturar diferentes tipos de eventos del sistema, proporcionando una visión más completa de las actividades que ocurren en un entorno Windows.

*   **Procmon (Process Monitor):** Como se describe en el blog de Blumira [1], Procmon es una herramienta avanzada de monitoreo en tiempo real que muestra la actividad del sistema de archivos, el Registro y los procesos/hilos. Es parte de la suite Sysinternals. Proporciona una vista detallada de las operaciones a nivel de sistema operativo, como la creación de procesos, el acceso a archivos y al registro, las conexiones de red y la carga de DLLs [2]. Su fortaleza radica en la captura exhaustiva de eventos en tiempo real [1].
*   **Sysmon (System Monitor):** Según la documentación oficial de Microsoft [3], Sysmon es un servicio del sistema y un controlador de dispositivos que registra la actividad del sistema en el registro de eventos de Windows. Se centra en eventos relevantes para la seguridad, como la creación de procesos (con la línea de comandos completa y hashes), conexiones de red, cambios en el tiempo de creación de archivos, entre otros. Sysmon enriquece los eventos con metadatos importantes como el GUID del proceso, el hash del proceso, y la relacion con el proceso padre [4].

**Complementariedad:**

*   **Amplitud vs. Profundidad:** Procmon ofrece una visión más amplia y detallada de las actividades del sistema en tiempo real [1], mientras que Sysmon proporciona una visión más profunda y centrada en la seguridad, con eventos filtrados y configurables [3].
*   **Tiempo real vs. Registro de eventos:** Procmon es ideal para el análisis en tiempo real y la resolución de problemas inmediatos, mientras que Sysmon registra eventos para un análisis posterior [1], permitiendo la correlación de eventos a lo largo del tiempo.
*   **Detalle de eventos:** Sysmon proporciona detalles contextuales enriquecidos en sus eventos [4]. Procmon, captura eventos similares, pero su enfoque en tiempo real puede requerir un análisis más manual para la correlación y contextualización.

En conjunto, Procmon permite una inspección minuciosa en tiempo real, mientras que Sysmon facilita la monitorización continua y la detección de amenazas a largo plazo [1, 3].

## 1.2. Ejemplo práctico de detección de comportamiento malicioso

**Escenario:** Detección de un proceso que realiza una inyección de DLL maliciosa.

**Herramientas:**

*   **Procmon:** Para monitorizar en tiempo real la actividad de los procesos y la carga de DLLs.
*   **Sysmon:** Configurado para registrar eventos de creación de hilos remotos (Event ID 8) e ImageLoad (Event ID 7).

**Configuración de Sysmon (fragmento de config.xml):**

```xml
<Sysmon schemaversion="4.50">
  <EventFiltering>
    <RuleGroup name="" groupRelation="or">
      <CreateRemoteThread onmatch="include">
        <TargetImage condition="end with">.exe</TargetImage>
      </CreateRemoteThread>
      <ImageLoad onmatch="include">
        <Image condition="end with">.dll</Image>
      </ImageLoad>
    </RuleGroup>
  </EventFiltering>
</Sysmon>
```

**Proceso de detección:**

1. **Monitoreo con Procmon:** Se inicia Procmon y se captura la actividad en tiempo real. Se observa un proceso legítimo, por ejemplo, `explorer.exe`, cargando una DLL sospechosa (`malicious.dll`) desde una ubicación inusual, como `C:\Temp\`.
2. **Análisis de Sysmon:** Se revisan los registros de Sysmon, que se almacenan en el Visor de Eventos de Windows [3], o se pueden exportar a un SIEM.
3. **Correlación de eventos:**
    *   Se busca un evento Sysmon con ID 8 (`CreateRemoteThread`) que tenga como `TargetImage` el proceso `explorer.exe` observado en Procmon.
    *   Se busca un evento Sysmon con ID 7 (`ImageLoad`) que coincida con la carga de `malicious.dll` observada en Procmon.
    *   Se analiza la información del evento Sysmon ID 8, como `SourceImage`, `SourceProcessId`, `StartAddress`, y `StartModule`, `StartFunction`.
    *   Se analiza la información del evento Sysmon ID 7, como la ruta completa de la DLL sospechosa y el hash de la DLL.
4. **Detección de comportamiento malicioso:** Si se encuentra un evento de `CreateRemoteThread` donde `explorer.exe` es el objetivo y un evento de `ImageLoad` que muestra la carga de `malicious.dll`, y `SourceImage` es un proceso no relacionado con `explorer.exe`, se puede inferir que el proceso `SourceImage` ha inyectado código malicioso en `explorer.exe`. La comparación de hashes con bases de datos como VirusTotal puede corroborar el comportamiento malicioso [1].

**Ejemplo de Evento Sysmon ID 8 (basado en [4]):**

```
CreateRemoteThread detected:
RuleName: -
UtcTime: 2023-12-29 20:37:19.819
SourceProcessGuid: {79e9f18a-6a5d-658f-1e01-000000000700}
SourceProcessId: 1234
SourceImage: C:\Users\user\Downloads\malicious_process.exe
TargetProcessGuid: {79e9f18a-6a4b-658f-1c01-000000000700}
TargetProcessId: 4321
TargetImage: C:\Windows\explorer.exe
NewThreadId: 5678
StartAddress: 0x00007FF874B01D40
StartModule: C:\Temp\malicious.dll
StartFunction: -
```

**Ejemplo de Evento Sysmon ID 7 (basado en [4]):**

```
Image loaded:
RuleName: -
UtcTime: 2023-12-29 20:37:19.821
ProcessGuid: {79e9f18a-6a4b-658f-1c01-000000000700}
ProcessId: 4321
Image: C:\Windows\explorer.exe
ImageLoaded: C:\Temp\malicious.dll
Hashes: MD5=f7b3b3a95b756fd921d25f28169c9092
Signed: false
Signature: -
SignatureStatus: -
```

**Conclusión:**

La combinación de Procmon y Sysmon permite detectar la inyección de DLL al observar la carga de la DLL sospechosa en tiempo real con Procmon y correlacionarla con los eventos de Sysmon que registran la creación del hilo remoto y la carga de la imagen. La información adicional proporcionada por Sysmon, como el proceso que origina la inyección, facilita la investigación y la respuesta al incidente.

# 2. Diferencias y utilidad de los eventos ProcessCreate y ProcessAccess en Sysmon

## 2.1. Descripción de los atributos principales

**ProcessCreate (Event ID 1) [3]:**

*   **UtcTime:** Hora UTC en que se registró el evento.
*   **ProcessGuid:** Identificador único del proceso.
*   **ProcessId:** Identificador del proceso.
*   **Image:** Ruta completa del archivo ejecutable del proceso.
*   **FileVersion:** Versión del archivo.
*   **Description:** Descripción del producto.
*   **Product:** Nombre del producto.
*   **Company:** Nombre de la compañía.
*   **OriginalFileName:** Nombre original del archivo, si fue renombrado.
*   **CommandLine:** Línea de comandos utilizada para iniciar el proceso.
*   **CurrentDirectory:** Directorio actual del proceso.
*   **User:** Usuario que inició el proceso.
*   **LogonGuid:** Identificador único de la sesión de inicio de sesión.
*   **LogonId:** Identificador de la sesión de inicio de sesión.
*   **TerminalSessionId:** Identificador de la sesión de la terminal.
*   **IntegrityLevel:** Nivel de integridad del proceso (Untrusted, Low, Medium, High, System, Protected).
*   **Hashes:** Hashes del archivo de imagen del proceso (SHA1, MD5, SHA256, IMPHASH).
*   **ParentProcessGuid:** Identificador único del proceso padre.
*   **ParentProcessId:** Identificador del proceso padre.
*   **ParentImage:** Ruta completa del archivo ejecutable del proceso padre.
*   **ParentCommandLine:** Línea de comandos del proceso padre.
*   **ParentUser:** Usuario del proceso padre (introducido en Sysmon 13).

**ProcessAccess (Event ID 10) [3]:**

*   **UtcTime:** Hora UTC en que se registró el evento.
*   **SourceProcessGUID:** Identificador único del proceso que accedió a otro proceso.
*   **SourceProcessId:** Identificador del proceso que accedió a otro proceso.
*   **SourceThreadId:** Identificador del hilo que realizó el acceso.
*   **SourceImage:** Ruta completa del archivo ejecutable del proceso que accedió a otro proceso.
*   **TargetProcessGUID:** Identificador único del proceso al que se accedió.
*   **TargetProcessId:** Identificador del proceso al que se accedió.
*   **TargetImage:** Ruta completa del archivo ejecutable del proceso al que se accedió.
*   **GrantedAccess:** Valor hexadecimal que representa los derechos de acceso solicitados o concedidos.
*   **CallTrace:** Pila de llamadas que condujo al evento. Incluye las DLLs cargadas.
*   **SourceUser:** Usuario del proceso que originó el acceso (introducido en Sysmon 13).
*   **TargetUser:** Usuario del proceso que fue accedido (introducido en Sysmon 13).

**Diferencias clave:**

*   **ProcessCreate** se genera cuando se **inicia un nuevo proceso** [4].
*   **ProcessAccess** se genera cuando un proceso **accede a la memoria de otro proceso** [4].
*   **ProcessCreate** proporciona información sobre el proceso creado, incluyendo su línea de comandos y proceso padre.
*   **ProcessAccess** proporciona información sobre el proceso que realiza el acceso y el proceso al que se accede, incluyendo los permisos solicitados y la pila de llamadas.

## 2.2. Escenarios prácticos para la detección de amenazas

**ProcessCreate (Event ID 1):**

*   **1. Detección de ejecución de comandos sospechosos:**

    *   **Escenario:** Un atacante utiliza PowerShell para descargar y ejecutar un script malicioso [4].
    *   **Detección:**
        *   Un evento ProcessCreate con `Image` como `C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe` y `CommandLine` que contiene indicadores sospechosos como “-ExecutionPolicy Bypass”, “iex”, “New-Object Net.WebClient”, “DownloadFile” o una URL codificada en Base64 [4].
    *   **Configuración de Sysmon:**

        ```xml
        <Sysmon schemaversion="4.50">
          <EventFiltering>
            <RuleGroup name="PowerShell Suspicious" groupRelation="or">
              <ProcessCreate onmatch="include">
                <Image condition="is">C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Image>
                <CommandLine condition="contains any">-ExecutionPolicy Bypass;iex;New-Object Net.WebClient;DownloadFile</CommandLine>
              </ProcessCreate>
            </RuleGroup>
          </EventFiltering>
        </Sysmon>
        ```

    *   **Ejemplo:** El artículo "Data-Driven Threat Hunting Using Sysmon" [4] menciona que se puede monitorear la ejecución de comandos como `schtasks.exe` (herramienta de Windows para crear tareas programadas) para detectar su uso en la persistencia de un atacante.

*   **2. Detección de procesos maliciosos con nombres o rutas inusuales:**

    *   **Escenario:** Un malware se copia a sí mismo a una carpeta temporal y se ejecuta desde allí con un nombre de proceso similar a un proceso legítimo [4].
    *   **Detección:**
        *   Un evento ProcessCreate con `Image` en una ruta inusual como `C:\Users\<username>\AppData\Local\Temp\svchost.exe` (imitando a `svchost.exe` legítimo).
    *   **Configuración de Sysmon:**

        ```xml
        <Sysmon schemaversion="4.50">
          <EventFiltering>
            <RuleGroup name="unusual process path" groupRelation="or">
              <ProcessCreate onmatch="include">
                <Image condition="contains">\AppData\Local\Temp\</Image>
                <Image condition="contains">\Temp\</Image>
              </ProcessCreate>
            </RuleGroup>
          </EventFiltering>
        </Sysmon>
        ```

**ProcessAccess (Event ID 10):**

*   **1. Detección de inyección de código:**

    *   **Escenario:** Un proceso malicioso inyecta código en un proceso legítimo como `explorer.exe` para evadir la detección [4].
    *   **Detección:**
        *   Un evento ProcessAccess con `SourceImage` que no es un proceso conocido por interactuar legítimamente con `TargetImage` (`explorer.exe`) y `GrantedAccess` que incluye permisos como `0x1F0FFF` (PROCESS_ALL_ACCESS) o `0x1F1FFF` (todos los permisos posibles, menos los permisos para modificar la seguridad del objeto) [4].
    *   **Configuración de Sysmon:**

        ```xml
        <Sysmon schemaversion="4.50">
          <EventFiltering>
            <RuleGroup name="Process Injection" groupRelation="or">
              <ProcessAccess onmatch="include">
                <TargetImage condition="is">C:\Windows\explorer.exe</TargetImage>
                <GrantedAccess condition="is">0x1F0FFF</GrantedAccess>
                <GrantedAccess condition="is">0x1F1FFF</GrantedAccess>
              </ProcessAccess>
            </RuleGroup>
          </EventFiltering>
        </Sysmon>
        ```

    *   **Ejemplo:** El artículo "Data-Driven Threat Hunting Using Sysmon" [4] menciona el uso de la herramienta Mimikatz, la cual accede a la memoria del proceso LSASS para extraer credenciales.

*   **2. Detección de acceso a procesos sensibles:**

    *   **Escenario:** Un atacante intenta leer la memoria del proceso `lsass.exe` para obtener credenciales (como en el caso de Mimikatz) [4].
    *   **Detección:**
        *   Un evento ProcessAccess con `TargetImage` como `C:\Windows\system32\lsass.exe` y `GrantedAccess` que indica permisos de lectura de memoria.
    *   **Configuración de Sysmon:**

        ```xml
        <Sysmon schemaversion="4.50">
          <EventFiltering>
            <RuleGroup name="LSASS Access" groupRelation="or">
              <ProcessAccess onmatch="include">
                <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
              </ProcessAccess>
            </RuleGroup>
          </EventFiltering>
        </Sysmon>
        ```

    *   **Ejemplo:** El documento "5 Benefits of Sysmon vs Windows Event Viewer" [1] menciona que Sysmon puede configurarse para detectar accesos a la memoria de procesos, sugiriendo el monitoreo de los procesos que acceden a `lsass.exe`.

Estos son solo algunos ejemplos. La clave para una buena detección de amenazas con Sysmon radica en comprender los patrones de comportamiento malicioso y traducirlos a reglas específicas en la configuración de Sysmon. La combinación de eventos ProcessCreate y ProcessAccess, junto con un análisis detallado de sus atributos, permite una detección robusta de una amplia gama de actividades maliciosas.

# 3. Relación entre Procmon y el evento FileCreateStreamHash de Sysmon

## 3.1. Alternate Data Streams (ADS)

**Definición:**

Los Alternate Data Streams (ADS) son una característica del sistema de archivos NTFS de Windows que permite asociar metadatos o flujos de datos adicionales a un archivo, sin alterar el contenido principal del mismo [6]. Estos flujos adicionales son "ocultos" para la mayoría de las aplicaciones de Windows, incluyendo el Explorador de Windows y el comando `DIR` en la línea de comandos.

**Funcionalidad:**

*   Permiten almacenar información adicional junto a un archivo, como autor, título, o incluso un archivo ejecutable completo.
*   Un archivo puede tener múltiples ADS asociados.
*   El flujo de datos principal de un archivo se denomina `$DATA` y es el único visible por defecto.
*   Los ADS se identifican con la sintaxis `nombre_archivo:nombre_flujo:$DATA`.

**Razones para su uso por parte de atacantes:**

*   **Ocultación de datos:** Los ADS permiten a los atacantes ocultar código malicioso, herramientas o datos robados dentro de un archivo aparentemente inocuo [6].
*   **Evasión de defensas:** Los antivirus y otras herramientas de seguridad pueden no escanear los ADS, permitiendo que el malware pase desapercibido.
*   **Persistencia:** El malware puede utilizar ADS para persistir en el sistema, incluso si se elimina el archivo principal.
*   **Ejecución de código:** Los atacantes pueden ejecutar código malicioso almacenado en un ADS [6].

**Ejemplo:**

Un atacante podría descargar un archivo de texto simple llamado `notas.txt`. Usando ADS, podría añadir un flujo de datos llamado `notas.txt:malware.exe:$DATA` que contenga un ejecutable malicioso.

## 3.2. Operaciones de Procmon relacionadas con ADS y configuración de Sysmon para FileCreateStreamHash

**Operaciones de Procmon relacionadas con ADS:**

Procmon, al ser una herramienta de monitoreo de bajo nivel, puede capturar las operaciones relacionadas con la creación y manipulación de ADS [1]. Las operaciones relevantes incluyen:

*   **CreateFile:** Aunque no es específica de ADS, esta operación puede indicar la creación del archivo principal al que se asocia el ADS.
*   **WriteFile:** Se utiliza para escribir datos en un ADS.
*   **SetInformationFile:** Se puede usar para renombrar un ADS.
*   **QueryStreamInformationFile:** Para obtener información sobre los flujos de un archivo, incluidos los ADS.

**Configuración de Sysmon para detectar el uso malicioso de ADS (FileCreateStreamHash - Event ID 15):**

Sysmon, a través del evento `FileCreateStreamHash` (ID 15), permite la detección específica de la creación de ADS [3]. La configuración debe enfocarse en la captura de este evento y, opcionalmente, en el filtrado basado en criterios sospechosos.

**Ejemplo de configuración (config.xml):**

```xml
<Sysmon schemaversion="4.50">
  <EventFiltering>
    <RuleGroup name="ADS" groupRelation="or">
      <FileCreateStreamHash onmatch="include">
        <TargetFilename name="technique_id=T1096,technique_name=Alternate Data Streams" condition="contains">:\$DATA</TargetFilename>
        <Image condition="exclude">C:\Windows\explorer.exe</Image> 
      </FileCreateStreamHash>
    </RuleGroup>
  </EventFiltering>
</Sysmon>
```

**Explicación:**

*   **`<FileCreateStreamHash onmatch="include">`:** Captura todos los eventos de creación de flujos de datos alternativos (ADS).
*   **`<TargetFilename condition="contains">:\$DATA</TargetFilename>`:** Captura todos los eventos de creación de ADS, ya que todos los ADS deben contener `:$DATA` en su nombre.
*   **`<Image condition="exclude">C:\Windows\explorer.exe</Image>`:** Excluye los eventos generados por el Explorador de Windows, ya que puede crear ADS legítimamente, como los ADS `Zone.Identifier`.

**Justificación:**

*   El evento `FileCreateStreamHash` (ID 15) captura la creación de ADS y proporciona información valiosa como el `Image` (proceso que crea el ADS), `TargetFilename` (nombre del archivo y del ADS), y el hash del contenido del ADS [4].
*   El filtro `condition="contains">:\$DATA` es importante para enfocar la búsqueda en los ADS, ya que es una parte fundamental de la nomenclatura de cualquier ADS.
*   La exclusión de `explorer.exe` reduce el ruido, ya que este proceso puede crear ADS legítimamente al descargar archivos de internet (e.g., el ADS `Zone.Identifier` que indica la zona de seguridad del archivo).
*   El nombre de la regla `technique_id=T1096,technique_name=Alternate Data Streams` asocia la regla a la táctica de MITRE ATT&CK, facilitando la correlación y el análisis.

**Ejemplo de código (detección de ADS con PowerShell):**

```powershell
Get-ChildItem -Path C:\ruta\al\archivo -Stream *
```

Este comando lista todos los flujos de datos, incluyendo los ADS, del archivo especificado en `C:\ruta\al\archivo`.

**Conclusión:**

Sysmon, a través del evento `FileCreateStreamHash` y una configuración adecuada, permite detectar la creación de ADS. Procmon puede complementar esta detección al proporcionar una visión en tiempo real de las operaciones de archivos, incluyendo aquellas relacionadas con ADS. La combinación de ambas herramientas, junto con el conocimiento de las técnicas de los atacantes, permite una detección más efectiva del uso malicioso de ADS.

# 4. Ventajas y diseño de filtros avanzados en Sysmon

## 4.1. Ventajas de los filtros avanzados y riesgos de un diseño deficiente

**Ventajas de utilizar filtros avanzados en Sysmon:**

*   **Reducción del ruido:** Sysmon genera una gran cantidad de eventos. Los filtros permiten enfocarse en los eventos relevantes para la detección de amenazas, eliminando el ruido generado por actividades legítimas del sistema [4].
*   **Mejora del rendimiento:** Al reducir la cantidad de eventos generados, se reduce la carga en el sistema de monitoreo y en los sistemas de almacenamiento y análisis de logs (como un SIEM) [1].
*   **Detección más precisa:** Los filtros permiten definir reglas específicas para detectar comport



1. Blumira. "5 Benefits of Sysmon vs Windows Event Viewer". _Blumira_, 2024. [Online]. Available: [https://www.blumira.com/blog/sysmon-benefits](https://www.blumira.com/blog/sysmon-benefits).
2. M. Xie, L. Liu, H. Yang, C. Wu and H. Geng, "SysMon: Monitoring Memory Behaviors via OS Approach," in _2017 IEEE 35th International Conference on Computer Design (ICCD)_, Boston, MA, USA, 2017, pp. 51-63, doi: 10.1109/ICCD.2017.17.
3. Microsoft. "Sysmon". _Microsoft Docs_, 2024. [Online]. Available: [https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon).
4. V. Mavroeidis and A. Jøsang, "Data-Driven Threat Hunting Using Sysmon," in _2018 the 2nd International Conference on Cryptography, Security and Privacy_, Guiyang, China, 2018, pp. 95-104, doi: 10.1145/3199478.3199490.
5. R.-V. Mahmoud, M. Anagnostopoulos, S. Pastrana and J. M. Pedersen, "Redefining Malware Sandboxing: Enhancing Analysis through Sysmon and ELK Integration," in _IEEE Access_, vol. 12, pp. 49907-49927, 2024, doi: 10.1109/ACCESS.2024.3400167.
6. C.R. Orton, C. G. Fraga, R. N. Christensen and J. M. Schwantes, "Proof of concept simulations of the Multi-Isotope Process monitor: An online, nondestructive, near-real-time safeguards monitor for nuclear fuel reprocessing facilities," _Nuclear Instruments and Methods in Physics Research Section A: Accelerators, Spectrometers, Detectors and Associated Equipment_, vol. 629, no. 1, pp. 209-219, 2011, doi: 10.1016/j.nima.2010.10.024.

